<!doctype html>
<html lang="zh-Hans-CN">
<head>
  <meta charset="utf-8" />
  <title>KPMG Audit Compass</title>
  <base href="/AuditCompass/">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- ECharts -->
  <script src="https://unpkg.com/echarts@5/dist/echarts.min.js"></script>

  <!-- ====== 平台基础样式（按你提供的变量/色板裁剪保留） ====== -->
  <style>
  html,body{width:100%;height:100%}
  *,*:before,*:after{box-sizing:border-box}
  html{font-family:sans-serif;line-height:1.15;-webkit-text-size-adjust:100%}
  body{margin:0;color:#000000d9;font-size:14px;
    font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";
    line-height:1.5715;background:var(--body-background)}
  :root{
    --primary-color:#1e49e2; --primary-color-opacity:rgba(30,73,226,.4);
    --deep-blue:#00338d; --base-space:16px;
    --table-head-background:#F6F8FE; --table-border:1px solid #f0f0f0;
    --warning-color:#faad14; --body-background:#f5f7fa;
    /* 兼容内容页自用变量 */
    --primary:#2563eb; --primary-600:#1e40af; --muted:#64748b; --text:#0f172a;
    --bg:#f5f7fa; --card:#fff; --border:#e8e8ed; --shadow:0 6px 18px rgba(17,24,39,.08);
  }

  /* ====== 顶部 Header（占位，类名保持，用于无缝替换） ====== */
  .layout-header {display:flex;align-items:center;height:48px;background:var(--primary-color);
    padding:0 16px;color:#fff;position:sticky;top:0;z-index:9999}
  .layout-header .layout-header-name{font-size:22px;font-weight:700}
  .layout-header .layout-header-project{margin-left:12px;opacity:.9}
  .layout-header .layout-header-nav{margin-left:auto;display:flex;gap:12px}

  /* ====== 主布局 ====== */
  .layout-main{display:flex;height:calc(100vh - 48px)}
  .sidebar{width:200px;background:#fff;border-right:1px solid #eaecef;overflow-y:auto}
  .sidebar-menu{list-style:none;margin:0;padding:8px}
  .sidebar-menu li{padding:8px 10px;border-radius:6px;cursor:pointer}
  .sidebar-menu li.active,.sidebar-menu li:hover{background:#f0f4ff}
  .main-right{flex:1;display:flex;flex-direction:column;overflow:hidden}
  .breadcrumb-bar{background:#fff;padding:6px 8px;color:#999;margin:0 var(--base-space)}
  .content-scroll{flex:1;overflow:auto}
  .content-wrap{margin:var(--base-space)}

  /* ====== 内容页（沿用你“完整版本”的风格） ====== */
  .container{max-width:1480px;margin:auto}
  .header{display:flex;align-items:center;gap:12px}
  .header .breadcrumb{font-size:13px;color:var(--muted)}
  .toolbar{margin-left:auto;display:flex;gap:10px}
  .btn{padding:6px 10px;border-radius:6px;border:1px solid var(--border);
    background:linear-gradient(135deg,#fff,#f9fafb);cursor:pointer;font-size:13px;transition:all .25s ease}
  .btn:hover{border-color:var(--primary);box-shadow:0 2px 6px rgba(37,99,235,.2)}
  .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-600));color:#fff;border:none}

  .tabbar{display:flex;gap:6px;border-bottom:2px solid var(--border);margin:10px 0 16px}
  .tab{padding:10px 14px;border-radius:8px 8px 0 0;color:var(--muted);cursor:pointer}
  .tab.active{background:#fff;border:1px solid var(--border);border-bottom:0;color:var(--primary)}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);margin-bottom:16px;overflow:hidden}
  .card .head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:#f9fbff;position:relative}
  .card .head::before{content:"";position:absolute;left:0;top:0;width:4px;height:100%;background:var(--primary)}
  .card .title{font-weight:600;margin-left:8px}
  .card .content{padding:14px 16px}
  .filters{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .filters label{font-size:12px;color:var(--text)}
  .select{padding:4px 8px;font-size:12px;color:var(--text);background:#fff;border:1px solid var(--border);
    border-radius:6px;min-width:100px;transition:all .25s ease;box-shadow:0 2px 5px rgba(0,0,0,.05);appearance:none}
  .select:hover{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .select:focus{outline:none;border-color:var(--primary-600);box-shadow:0 0 0 3px rgba(37,99,235,.25)}
  .chart{height:300px}

  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{border:1px solid var(--border);padding:8px;text-align:center;white-space:nowrap}
  .table th{background:#f1f5ff;color:#1e293b;font-weight:600}
  .table tr:hover td{background:#f9fbff}
  .table-tabs{display:flex;gap:10px;margin:10px 0}
  .table-tab{padding:6px 14px;border:1px solid var(--border);border-radius:8px;background:#f8fafc;color:var(--muted);cursor:pointer}
  .table-tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}

  .split{display:grid;grid-template-columns:300px 1fr;gap:16px}
  .sidebar-pane{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  .menu{display:flex;flex-direction:column;gap:6px}
  .menu .item{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#eef2ff;cursor:pointer;font-size:13px}
  .menu .item.active{background:#fff;outline:2px solid var(--primary-600)}
  .small{font-size:12px;color:var(--muted)}
  .top-strip{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  .top-item{background:#f9fafb;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  .top-item .lbl{font-size:12px;color:var(--muted)}
  .top-item .num{font-weight:700;margin-top:6px}
  .rank-list{display:grid;gap:6px;margin-top:6px}
  .rank-row{display:flex;align-items:center;justify-content:space-between;font-size:12px;border-bottom:1px dashed var(--border);padding:4px 0}
  .rank .bul{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px}
  .grid-2{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .pagination{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
  .pagination .btn{padding:6px 10px}
  .hide{display:none}
  #tblTop20 {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  #tblTop20 th, #tblTop20 td {
    border: 1px solid #e5e7eb;
    padding: 6px 8px;
    text-align: center;
  }
  #tblTop20 th {
    background: #f9fafb;
    font-weight: 600;
  }
  .color-dot {
    display:inline-block;
    width:10px;
    height:10px;
    border-radius:50%;
    margin-right:4px;
  }
  /* === Sidebar: final, deduped === */
.layout-main{display:flex;height:calc(100vh - 48px);}
.sidebar{flex:0 0 230px;background:#f8f8f8;border-right:1px solid #ddd;padding:10px 16px;}
.main-right{flex:1;min-width:0;display:flex;flex-direction:column;}

.sidebar .sidebar-menu,
.sidebar .sidebar-menu ul,
.sidebar .sb-submenu{list-style:none;margin:0;padding-left:0}

/* 顶层项：项目列表（不折叠） */
.sidebar .sidebar-menu > li:not(.sb-toggle){
  display:flex;align-items:center;gap:8px;
  padding:12px 8px;border-radius:8px;
  color:#003366;font-size:15px;cursor:pointer;
}
.sidebar .sidebar-menu > li:not(.sb-toggle):hover{background:#eef3f8;}
.sidebar .ico{width:16px;text-align:center;font-size:14px;color:#003366;}
.sidebar .sb-txt{color:#003366;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sidebar .caret{margin-left:auto;font-size:12px;color:#8a8a8a;transition:transform .18s;}

/* 可折叠项：工作簿详情（纵向容器） */
.sidebar .sb-toggle{display:block;padding:0;}
.sidebar .sb-toggle-head{
  display:flex;align-items:center;gap:8px;
  padding:12px 8px;border-radius:8px;color:#003366;cursor:pointer;
}
.sidebar .sb-toggle-head:hover{background:#eef3f8;}
.sidebar .sb-toggle.open .caret{transform:rotate(90deg);}

/* 二级菜单（嵌入 sb-toggle 内） */
.sidebar .sb-submenu{display:none;margin:4px 0 8px 16px;}
.sidebar .sb-toggle.open > .sb-submenu{display:block;}

/* 二级行：两列网格（图标/文本），无图标项占位以对齐 */
.sidebar .sb-submenu .sb-row{
  display:grid;grid-template-columns:18px 1fr;align-items:center;
  column-gap:8px;padding:8px 6px;border-radius:8px;color:#333;font-size:14px;cursor:pointer;
}
.sidebar .sb-submenu .sb-row:hover{background:#eef3f8;color:#2f5ea8;}
.sidebar .sb-submenu .sb-row .sb-txt{color:#333;}
.sidebar .sb-submenu .sb-row:not(.active)::before{content:"";width:18px;height:18px;}

/* 选中：只有“银行流水分析”有绿色圆圈与高亮 */
.sidebar .sb-submenu .sb-row.active{background:#e9f2ff;font-weight:600;color:#2f5ea8;}
.sidebar .sb-submenu .sb-row.active .sb-txt{color:#2f5ea8;}
.sidebar .sb-submenu .sb-row.active .ico{color:#32b27c;font-size:15px;}

/* 置灰禁用项样式 */
.sidebar .sb-submenu .sb-row.disabled {
  color: #999 !important;
  background: transparent !important;
  cursor: not-allowed !important;
  opacity: 0.6;
  pointer-events: none;  /* 禁止点击 */
}

.sidebar .sb-submenu .sb-row.disabled .sb-txt {
  color: #999 !important;
}
.main-right { flex:1; display:flex; flex-direction:column; }
.breadcrumb-bar {
  background:#fff;
  border-bottom:1px solid #e6edf5;
  padding:12px 20px;
  font-size:14px;
  color:#334155;
}
.breadcrumb-bar .back-link {
  color:#003366;
  text-decoration:none;
  font-weight:600;
  margin-right:4px;
}
.breadcrumb-bar .sep { margin:0 6px; color:#94a3b8; }
.breadcrumb-bar b { color:#003366; }

.content-scroll { flex:1; overflow:auto; }
.content-wrap { padding:16px 20px 32px; }

/* 面包屑 */
.breadcrumb-bar{background:#fff;border-bottom:1px solid #e6edf5;padding:12px 20px;font-size:14px;color:#334155}
.breadcrumb-bar .back-link{color:#003366;text-decoration:none;font-weight:600;margin-right:4px}
.breadcrumb-bar .sep{margin:0 6px;color:#94a3b8}
.breadcrumb-bar b{color:#003366}

/* 顶部整体：左 KPI + 右 问题分析 */
.kpi-and-issue{
  display:grid;
  grid-template-columns: minmax(520px, 1fr) 520px;
  gap:10px;
  padding:8px 16px 6px;
}

/* 左侧 KPI：两行结构（前三列更瘦，右两列更长） */
.kpi-grid{
  display:grid;
  grid-template-columns: 0.8fr 0.8fr 0.8fr 1.2fr 1.2fr;
  grid-template-rows: 64px 64px;
  gap:10px;
  align-items:stretch;
  grid-template-areas:
    "k1 k2 k3 k4 k5"
    "k1 k2 k3 k6 k7";
}

/* KPI 区域映射 */
.k1{ grid-area:k1; } .k2{ grid-area:k2; } .k3{ grid-area:k3; }
.k4{ grid-area:k4; } .k5{ grid-area:k5; } .k6{ grid-area:k6; } .k7{ grid-area:k7; }

/* 通用 KPI 样式 */
.kpi{
  background:#f8fafc;
  border:1px solid #e6edf5;
  border-radius:8px;
  padding:6px 10px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:flex-start;
}
.kpi-label{
  font-size:17px;
  color:#334155;
  font-weight:600;
  margin-bottom:3px;
  white-space:nowrap;
}
.kpi-value{
  font-size:17px;
  font-weight:700;
  color:#0f172a;
  line-height:1.1;
  white-space:nowrap;
}
.kpi-value.pos{color:#0f7a43}
.kpi-value.neg{color:#b2162a}
.link-num{ text-decoration:none; border-bottom:1px dotted currentColor }
.link-num:hover{ opacity:.85 }
.link-num.danger{ color:#D2283E }

/* ✅ 前三列（k1~k3）内容整体居中 */
.k1, .k2, .k3 {
  display:flex !important;
  flex-direction:column !important;
  justify-content:center !important;
  align-items:center !important;
  text-align:center !important;
}

/* ✅ 右侧 2×2（k4~k7）横排，数值右对齐 */
.k4,.k5,.k6,.k7{
  display:flex !important;
  flex-direction:row !important;
  align-items:center !important;
  justify-content:space-between !important;
}
.k4 .kpi-label,.k5 .kpi-label,.k6 .kpi-label,.k7 .kpi-label{margin-bottom:0}
.k4 .kpi-value,.k5 .kpi-value,.k6 .kpi-value,.k7 .kpi-value{
  margin-left:auto; text-align:right;
}

/* ✅ 数据问题分析卡（与左侧KPI总高一致） */
.issue-card{
  background:#fffdf7;
  border:1px solid #ffe6b3;
  border-radius:8px;
  padding:10px 12px;
  height:calc(60px * 2 + 10px);  /* 跟左侧两行总高一致（2*行高 + gap） */
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.issue-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
}
.issue-title{color:#8a5c00;font-weight:600}
.issue-link{
  font-size:12px;
  color:#8a5c00;
  text-decoration:none;
  border:1px solid #f5cf85;
  padding:2px 8px;
  border-radius:999px;
  background:#fff7e3;
}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.dot-warn{background:#f59e0b;box-shadow:0 0 0 3px rgba(245,158,11,.15)}
.issue-body{color:#8a5c00;font-size:12px;line-height:1.45;flex:1;overflow:auto}
.issue-foot{margin-top:6px}
.mini-link{font-size:12px;color:#8a5c00;text-decoration:underline}

/* ====== 数据问题卡核心样式 ====== */
.issue-card{
  position: relative;
  background:#fffdf7;
  border:1px solid #ffe6b3;
  border-radius:8px;
  padding:10px 12px 30px;         /* 预留底部空间给固定按钮 */
  height:calc(60px * 2 + 10px);   /* 保持与左侧两行KPI等高 */
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  overflow:hidden;                /* 防止外溢 */
}

/* 顶部标题栏 */
.issue-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
}
.issue-title{color:#8a5c00;font-weight:600;font-size:14px;}
.issue-link{
  font-size:12px;
  color:#8a5c00;
  text-decoration:none;
  border:1px solid #f5cf85;
  padding:2px 8px;
  border-radius:999px;
  background:#fff7e3;
}
.issue-link:hover{background:#ffeab5;}

/* 内容区可滚动 */
.issue-body-simple{
  font-size:12px;
  color:#8a5c00;
  line-height:1.65;
  overflow-y:auto;
  padding-right:8px;
  flex:1;
}

/* 第一行说明 */
.issue-note b{ color:#8a5c00; }

/* 第二行：红色警示 + 跳转链接 */
.issue-inline{
  display:flex;
  align-items:center;
  gap:6px;
  margin:0;
  flex-wrap:wrap;
}
.dot-danger{
  width:8px;
  height:8px;
  border-radius:50%;
  background:#dc2626;
  box-shadow:0 0 0 3px rgba(220,38,38,.12);
}
.issue-inline span{
  color:#b2162a;
  font-weight:500;
}
.issue-inline-link{
  color:#b2162a;
  font-weight:600;
  text-decoration:none;
  border-bottom:1px dotted currentColor;
  margin-left:4px;
}
.issue-inline-link:hover{ opacity:.85; }

/* 固定右下角按钮 */
.issue-toggle{
  position:absolute;
  right:12px;
  bottom:8px;
  font-size:12px;
  color:#475569;
  text-decoration:underline;
  background:#fffdf7;
  padding:2px 6px;
  border-radius:4px;
  cursor:pointer;
  z-index:2;
}
.issue-toggle:hover{ color:#003366 }

/* 可选：细滚动条（美化） */
.issue-body-simple::-webkit-scrollbar{ width:6px; }
.issue-body-simple::-webkit-scrollbar-thumb{
  background:rgba(0,0,0,.15);
  border-radius:4px;
}
.issue-body-simple::-webkit-scrollbar-track{ background:transparent; }

/* Tabs：更贴近 KPI */
.tabbar{
  display:flex;align-items:center;border-bottom:1px solid #e6edf5;
  margin:8px 16px 0;
}
.tab{padding:10px 16px;cursor:pointer;color:#475569;border-bottom:2px solid transparent}
.tab:hover{background:#f3f6fb}
.tab.active{color:#003366;font-weight:600;border-bottom-color:#003366}
.tab.disabled{color:#c0c7d0;pointer-events:none}

/* ✅ Tab 容器卡片风格 */
.tab-container {
  background:#fff;
  border:1px solid #e6edf5;
  border-radius:8px;
  margin:10px 16px 0;
  padding:12px 20px 18px;
  box-shadow:0 1px 3px rgba(0,0,0,0.04);
}

/* ✅ 图表区块也包裹在卡片中更融合 */
.chart-card {
  background:#fff;
  border:1px solid #e6edf5;
  border-radius:8px;
  padding:16px;
  margin:10px 16px;
  box-shadow:0 1px 3px rgba(0,0,0,0.03);
}

/* ================== 经营实质滚动容器（功能 + 美化） ================== */
:root{
  --page-gutter: 16px;     /* 与上方KPI左右留白一致 */
  --tabs-offset: 270px;    /* (视口高度 - 这个值) = 白板可视高度，可按页面微调 */
}

/* 顶部 tabs 与 KPI 对齐 */
.tabbar{ margin: 8px var(--page-gutter) 0; }

/* ★ 保险补丁：即使 tabbar/tab-stage 被写进 .kpi-and-issue 的 grid，也强制跨整行 */
.kpi-and-issue .tabbar,
.kpi-and-issue .tab-stage{
  grid-column: 1 / -1 !important;  /* 占满两列 */
  width: 100% !important;
  min-width: 0 !important;
  float: none !important;
}

/* 统一“白板舞台”容器：固定高度，内部滚动，两个面板共用 */
.tab-stage{
  /* 尺寸与位置 */
  margin: 10px var(--page-gutter) 0;
  width: 100%;
  min-width: 0;                 /* ★ 关键：在 flex/grid 父容器里避免被横向压瘦 */
  flex: 1 1 auto;               /* ★ 父级是 flex 时可正常伸展 */
  position: relative;
  height: calc(100vh - var(--tabs-offset)); /* 固定白板高度，内部滚动 */
  overflow: hidden;

  /* 视觉 */
  background:#fff;
  border:1px solid #e8edf5;
  border-radius:10px;
  box-shadow:0 2px 10px rgba(17,24,39,.04);

  /* 性能 */
  contain: layout paint;         /* 降低重绘“鬼影”概率 */
}

/* 两个面板重叠铺满白板，只显示 active */
.tab-pane{
  position:absolute; inset:0;
  display:none;
  overflow:hidden;
}
.tab-pane.active{ display:block; }

/* 真正滚动的区域：把筛选/图表/表格都放进来 */
.tab-scroll{
  position:absolute; inset:0;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding:12px 14px 16px;
}

/* 白板里卡片：统一风格 */
.tab-scroll > .card{
  border:1px solid #e9eef6 !important;
  border-radius:10px !important;
  background:#fff !important;
  box-shadow:0 2px 10px rgba(17,24,39,.04) !important;
  margin:12px 0 !important;
  overflow:visible;
}

/* 卡片标题：左侧细竖条强调；禁止 sticky 以免叠影 */
.tab-scroll .card .head{
  position:static !important;    /* ★ 防止“吸顶”导致的叠影 */
  background:#fbfdff;
  border-bottom:1px solid #eef2f7;
  padding:10px 14px;
}
.tab-scroll .card .head .title{
  font-weight:600; color:#0f172a; position:relative; padding-left:10px;
}
.tab-scroll .card .head .title::before{
  content:""; position:absolute; left:0; top:50%; transform:translateY(-50%);
  width:3px; height:16px; border-radius:2px; background:#1e49e2; opacity:.9;
}
.tab-scroll .card .content{ padding:14px 16px 16px; overflow:hidden; }

/* 图表统一高度（可按需调） */
.tab-scroll .chart{ height:260px; max-height:38vh; min-height:220px; }

/* 表格细化 */
.tab-scroll .table{ width:100%; border-collapse:collapse; font-size:13px; }
.tab-scroll .table th,.tab-scroll .table td{
  border:1px solid #eef2f7; padding:8px 10px; text-align:center; white-space:nowrap;
}
.tab-scroll .table th{ background:#f7faff; color:#334155; font-weight:600; }
.tab-scroll .table tr:hover td{ background:#f8fbff; }

/* 滚动条美化（可选） */
.tab-scroll::-webkit-scrollbar{ width:6px }
.tab-scroll::-webkit-scrollbar-thumb{ background:rgba(15,23,42,.18); border-radius:4px }
.tab-scroll::-webkit-scrollbar-track{ background:transparent }

/* 保险：外层可伸展容器取消最小宽度限制，避免被压瘦成右侧细缝 */
.main-right, .content-scroll, .content-wrap, .tabbar{ min-width: 0; }

/* Routine 右侧的双列布局间距 */
.grid-2{ display:grid; grid-template-columns: 2fr 1.2fr; gap: 16px; }

/* 窄屏时把 offset 调小一些，避免白板过矮 */
@media (max-width: 1366px){
  :root{ --tabs-offset: 300px; }
}

/* 响应式：窄屏堆叠（保留原逻辑） */
@media (max-width:1200px){
  .kpi-and-issue{ grid-template-columns: 1fr; }
  .issue-card{ order:2 }
}

/* ===== 筛选区：label 普通，筛选框才是胶囊 ===== */
.filter-card {
  background: #fff;
  border: 1px solid #e6edf5;
  border-radius: 10px;
  padding: 18px 24px;
  margin: 10px 16px 12px;
  max-width: calc(100% - 32px);               /* 宽度略窄，使内容更集中 */
  box-shadow: 0 2px 8px rgba(17,24,39,0.05);
}
.filter-area {
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-start;  /* 想整体居中可改 center */
  gap:12px 16px;
  padding:10px 0 14px;
}

/* label 保持文字说明样式 */
.filter-area label {
  font-size:14px;
  color:#334155;
  font-weight:600;
  line-height:36px;
  margin-right:6px;
}

/* 所有输入/下拉框统一胶囊化 */
.filter-area select,
.filter-area input[type="text"],
.filter-area input[type="date"] {
  font-size:14px;
  height:36px;
  line-height:36px;
  padding:0 14px;
  min-width:160px;
  border:1px solid #cfd9e5;
  border-radius:50px;  /* ← 关键：圆角“胶囊”效果 */
  background:#fff;
  box-shadow:0 1px 2px rgba(0,0,0,0.04);
  transition:all .2s ease;
}

/* hover / focus 状态 */
.filter-area select:hover,
.filter-area input[type="text"]:hover,
.filter-area input[type="date"]:hover {
  border-color:#1e49e2;
  box-shadow:0 0 0 3px rgba(30,73,226,0.08);
}
.filter-area select:focus,
.filter-area input[type="text"]:focus,
.filter-area input[type="date"]:focus {
  outline:none;
  border-color:#0d3bc4;
  box-shadow:0 0 0 3px rgba(13,59,196,0.12);
}

/* 日期范围中“至”的分隔符 */
.filter-area .range-sep {
  margin:0 6px;
  color:#64748b;
  font-size:13px;
  line-height:36px;
  user-select:none;
}

/* 查询 / 重置按钮 */
.filter-area button {
  height:36px;
  font-size:14px;
  padding:0 18px;
  border-radius:50px;    /* 与筛选框保持统一圆角风格 */
  border:none;
  cursor:pointer;
  transition:0.2s;
}
.filter-area .query {
  background:#1e49e2;
  color:#fff;
}
.filter-area .query:hover {
  background:#0d3bc4;
}
.filter-area .reset {
  background:#eef3fb;
  color:#334155;
}
.filter-area .reset:hover {
  background:#e6eefc;
  color:#1e293b;
}

/* 窄屏适配 */
@media (max-width:1200px){
  .filter-area{
    justify-content:center;
    gap:10px 12px;
  }
  .filter-area select,
  .filter-area input{
    min-width:130px;
  }
}
    
</style>
</head>

<body>
  <!-- ====== 平台 Header ====== -->
  <header class="layout-header">
    <div _ngcontent-ng-c2218024402="" class="header-menu-control" style="position: relative;"><svg _ngcontent-ng-c2218024402="" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: var(--responsive-size-16); height: var(--responsive-size-16);"><path _ngcontent-ng-c2218024402="" fill-rule="evenodd" clip-rule="evenodd" d="M1.40003 2.79995C1.40003 2.46858 1.66866 2.19995 2.00003 2.19995L14.8 2.19995C15.1314 2.19995 15.4 2.46858 15.4 2.79995C15.4 3.13132 15.1314 3.39995 14.8 3.39995L2.00003 3.39995C1.66866 3.39995 1.40003 3.13132 1.40003 2.79995ZM15.0909 5.47515C15.2816 5.58088 15.4 5.7818 15.4 5.9999L15.4003 9.9999C15.4004 10.218 15.282 10.419 15.0912 10.5247C14.9005 10.6305 14.6673 10.6244 14.4824 10.5088L11.2821 8.50876C11.1066 8.39913 11 8.20684 11 7.99996C11 7.79309 11.1066 7.6008 11.282 7.49115L14.482 5.49115C14.667 5.37556 14.9001 5.36943 15.0909 5.47515ZM12.7321 7.99993L14.2003 8.91741L14.2001 7.08245L12.7321 7.99993ZM1.40003 6.26662C1.40003 5.93524 1.66865 5.66662 2.00002 5.66662L8.40003 5.66662C8.7314 5.66662 9.00003 5.93525 9.00003 6.26662C9.00003 6.59799 8.7314 6.86662 8.40003 6.86662L2.00002 6.86662C1.66865 6.86662 1.40002 6.59799 1.40003 6.26662ZM1.40002 9.73328C1.40002 9.40191 1.66865 9.13328 2.00002 9.13328H8.40003C8.7314 9.13328 9.00003 9.40191 9.00003 9.73328C9.00003 10.0647 8.7314 10.3333 8.40003 10.3333H2.00002C1.66865 10.3333 1.40002 10.0647 1.40002 9.73328ZM1.40002 13.1999C1.40002 12.8686 1.66865 12.5999 2.00002 12.5999L14.8 12.6C15.1314 12.6 15.4 12.8686 15.4 13.2C15.4 13.5313 15.1314 13.8 14.8 13.8L2.00002 13.7999C1.66865 13.7999 1.40002 13.5313 1.40002 13.1999Z" fill="white"></path></svg><!----><!----></div>
    <div _ngcontent-ng-c2218024402="" class="layout-header-name">KPMG Audit Compass <span _ngcontent-ng-c2218024402="" class="layout-header-project ng-star-inserted">Test2 20251022</span><!----></div>
    <nav class="layout-header-nav">
      <span>中/EN</span>
      <span>Eric</span>
      <span>设置</span>
    </nav>
  </header>

  <!-- ====== 主体区域：左侧平台侧栏 + 右侧内容滚动容器 ====== -->
<div class="layout-main">
  <!-- 左侧 -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <!-- 顶层：项目列表 -->
      <li>
        <i class="fa-solid fa-bars ico"></i>
        <span class="sb-txt">项目列表</span>
      </li>
  
      <!-- 顶层：工作簿详情（下拉） -->
      <li class="sb-toggle">
        <div class="sb-toggle-head" onclick="toggleSb(this.parentElement)">
          <i class="fa-solid fa-folder ico"></i>
          <span class="sb-txt">工作簿详情</span>
          <i class="fa-solid fa-angle-right caret"></i>
        </div>
  
        <!-- 二级菜单：只有“银行流水分析”有绿色圆圈 -->
        <ul class="sb-submenu">
          <li class="sb-row active">
            <i class="fa-regular fa-circle-check ico"></i>
            <span class="sb-txt">数据上传</span>
          </li>
          <li class="sb-row active">
            <i class="fa-regular fa-circle-check ico"></i>
            <span class="sb-txt">银行流水分析</span>
          </li>
          <li class="sb-row disabled"><span class="sb-txt">增值税数据分析</span></li>
          <li class="sb-row disabled"><span class="sb-txt">财务数据分析</span></li>
          <li class="sb-row disabled"><span class="sb-txt">数据综合分析</span></li>
        </ul>
      </li>
    </ul>
  </aside>

  
  <!-- 右侧（必须与 aside 同级，且共同包在 layout-main 内） -->
  <section class="main-right">
    <div class="breadcrumb-bar">
      <a href=" " class="back-link">← 返回项目列表</a >
      <span class="sep">/</span> <span>Test2</span>
      <span class="sep">/</span> <span>20251022</span>
      <span class="sep">/</span> <b>银行流水分析</b>
    </div>
    
    <!-- 2) KPI + 数据问题分析（整块） -->
    <div class="kpi-and-issue">
      <!-- 左侧 KPI 总容器：左1列(前三个纵排) + 右2列(后四个2×2) -->
      <div class="kpi-grid">
        <div class="kpi k1">
          <div class="kpi-label">被审计单位</div>
          <div class="kpi-value">1 家</div>
        </div>
        <div class="kpi k2">
          <div class="kpi-label">对手方</div>
          <div class="kpi-value">29 家</div>
        </div>
        <div class="kpi k3">
          <div class="kpi-label">账号</div>
          <div class="kpi-value">17 个</div>
        </div>
    
        <div class="kpi k4">
          <div class="kpi-label">交易总额</div>
          <div class="kpi-value">562.2 K</div>
        </div>
        <div class="kpi k5">
          <div class="kpi-label">流水总数</div>
          <div class="kpi-value">145 笔</div>
        </div>
        <div class="kpi k6">
          <div class="kpi-label">流入总额</div>
          <div class="kpi-value pos"><a class="link-num" href="javascript:;">270.2 K</a ></div>
        </div>
        <div class="kpi k7">
          <div class="kpi-label">流出金额</div>
          <div class="kpi-value neg"><a class="link-num danger" href="javascript:;">292.0 K</a ></div>
        </div>
      </div>
    
      <!-- 右侧：数据问题分析 -->
      <!-- 数据问题分析卡 -->
      <aside class="issue-card">
        <div class="issue-head">
          <span class="issue-title">数据问题分析</span>
        </div>
        <!-- 滚动内容区 -->
        <div class="issue-body-simple">
          <p class="issue-note">
            <b>仅供预览分析：</b>
            当前数据存在未认领 / 银行账号主档不完整的问题，仅供项目组进行风险评估，实质性审计程序不可依赖。
          </p >
      
          <p class="issue-inline">
            <span class="dot-danger"></span>
            <span>存在未认领的原始流水文件，请及时认领。</span>
            <a class="issue-inline-link" href="#认领页面">点击跳转 »</a >
          </p >
      
          <!-- 可追加更多问题 -->
          <p class="issue-inline">
            <span class="dot-danger"></span>
            <span>银行流水中，存在未在银行账号主档维护的账号，请补充银行账号主档</span>
            <a class="issue-inline-link" href="#详情">点击跳转 »</a >
          </p >

          <p class="issue-inline">
            <span class="dot-danger"></span>
            <span>存在汇率未转换的流水，请及时补充汇率主档</span>
            <a class="issue-inline-link" href="#详情">点击跳转 »</a >
          </p >

          <p class="issue-inline">
            <span class="dot-danger"></span>
            <span>存在当日不连续的流水文件，可在月度分布处手工打标首尾笔重新验证，请及时处理并确认无误</span>
            <a class="issue-inline-link" href="#详情">点击跳转 »</a >
          </p >
        </div>
      
        <!-- 固定底栏：展开详情 -->
        <a class="issue-toggle" href="javascript:void(0)">展开详情</a >
      </aside>
    
    <!-- 3) Tabs（紧贴在KPI/问题卡下面） -->
    <div class="tabbar" id="topTabs">
      <div class="tab active" data-top="biz">经营实质</div>
      <div class="tab" data-top="routine">特定工商查询</div>
    </div>
    
    <!-- 统一白板舞台：两个面板共用同一块“白板” -->
    <div class="tab-stage">
    
      <!-- ===================== 经营实质 面板 ===================== -->
      <section class="tab-pane active" id="pane-biz">
        <div class="tab-scroll">
      
          <!-- 1) 只放筛选区：.filter-card 里只保留 .filter-area -->
          <div class="filter-card">
            <div class="filter-area">
              <label>被审计单位公司：</label><select class="select" id="fCompany"></select>
      
              <label>银行账户：</label><select class="select" id="fBank"></select>
      
              <label>公司职能：</label><select class="select" id="fFunc"></select>
      
              <label>分析时间：</label>
              <input type="date" id="beginDate" />
              <span class="range-sep">至</span>
              <input type="date" id="endDate" />
      
              <label>对手方类型：</label>
              <select class="select" id="fType">
                <option value="all">全部</option><option>客户</option><option>供应商</option><option>员工</option>
              </select>
      
              <button class="query" id="btnQueryBiz">查询</button>
              <button class="reset" id="btnResetBiz">重置</button>
            </div>
          </div> <!-- ← 这里结束 filter-card -->
      
          <!-- 2) 资金流水金额（独立卡片） -->
          <div class="card">
            <div class="head"><div class="title">资金流水金额</div></div>
            <div class="content"><div id="chart-balance" class="chart"></div></div>
          </div>
      
          <!-- 3) 流入流出趋势（独立卡片） -->
          <div class="card">
            <div class="head"><div class="title">流入流出趋势</div></div>
            <div class="content"><div id="chart-io" class="chart"></div></div>
          </div>
      
          <!-- 4) 构成 + 表格（独立卡片） -->
          <div class="card">
            <div class="head"><div class="title">流入流出构成</div></div>
            <div class="content">
              <div id="chart-compose" class="chart"></div>
      
              <div class="table-tabs" id="listTabs">
                <div class="table-tab active" data-view="deal">交易明细</div>
                <div class="table-tab" data-view="corp">工商信息</div>
              </div>
      
              <!-- 交易明细 -->
              <div id="tbl-deal-wrap">
                <table class="table" id="tblDeal">
                  <thead>
                  <tr>
                    <th>对手方名称</th><th>对手方类型</th><th>关联关系</th><th>黑名单</th>
                    <th>流入总额</th><th>流出总额</th><th>交易总额</th><th>交易总额占比</th><th>交易笔数</th>
                    <th>销售类别</th><th>采购类别</th><th>职位</th><th>备注说明</th><th>操作</th>
                  </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div id="pagination-deal" class="pagination"></div>
              </div>
      
              <!-- 工商信息 -->
              <div id="tbl-corp-wrap" class="hide">
                <table class="table" id="tblCorp">
                  <thead>
                  <tr>
                    <th>对手方名称</th><th>交易总额</th><th>成立日期</th><th>经营开始时间</th>
                    <th>经营结束时间</th><th>营业期限</th><th>经营状态</th><th>注册资本</th>
                    <th>行业</th><th>经营范围</th><th>注册地址</th><th>企业联系方式</th><th>董监高</th>
                  </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div id="pagination-corp" class="pagination"></div>
              </div>
            </div>
          </div>
      
        </div>
      </section>
    
      <!-- ===================== 特定工商查询 面板 ===================== -->
      <section class="tab-pane" id="pane-routine">
        <div class="tab-scroll">
          <div class="split">
            <!-- 左侧菜单 -->
            <aside class="sidebar-pane">
              <div class="menu" id="routineMenu">
                <div class="item active" data-code="2.1">1. 经营时间较短</div>
                    <div class="item" data-code="2.2">2. 社保缴纳人数较少</div>
                    <div class="item" data-code="2.3">3. 为个人或个体工商户</div>
                    <div class="item" data-code="2.3">4. 注册资本与交易规模不匹配</div>
                    <div class="item" data-code="2.3">5. 交易规模与第三方所处行业状况不匹配</div>
                    <div class="item" data-code="2.3">6. 经营范围与交易性质不匹配</div>
                    <div class="item" data-code="2.3">7. 注册地址与被审计单位地址较为接近</div>
                    <div class="item" data-code="2.3">8. 不同第三方的工商登记信息相同或相近；</div>
                    <div class="item" data-code="2.3">9. 既是客户又是供应商,或受同一实际控制人控制</div>
                  <div class="small">说明：切换 Routine 仅刷新右侧内容。</div>
                </aside>

                <main>
                  <div class="card">
                    <div class="head">
                      <div class="title" id="rTitle">1. 经营时间较短 · 结果</div>
                      <div class="filters" id="routineFilters"></div>
                    </div>
                    <div class="content">
                      <div class="top-strip" id="topStrip"></div>
                    </div>
                  </div>

                  <div class="grid-2">
                    <!-- 左边：散点图 + Top20 -->
                    <div>
                      <!-- 散点图 -->
                      <div class="card">
                        <div class="head"><div class="title" id="scatterTitle">散点分布（含正态拟合）</div></div>
                        <div class="content"><div id="chart-scatter" class="chart"></div></div>
                      </div>

                      <!-- Top20 表格 -->
                      <div class="card">
                        <div class="head"><div class="title">Top20 交易额总览</div></div>
                        <div class="content" style="display:flex;gap:20px;align-items:flex-start;">

                          <!-- 左边：Top20 表格 -->
                          <div style="flex:3;overflow:auto;">
                            <div class="small">Top20交易额总额：<b id="rankTotal">—</b></div>
                            <table class="table" id="tblTop20">
                              <thead>
                                <tr>
                                  <th>排名</th>
                                  <th>对手方名称</th>
                                  <th>交易总额</th>
                                  <th>流入总额</th>
                                  <th>流出总额</th>
                                  <th>交易笔数</th>
                                  <th>类型</th>
                                  <th>关联关系</th>
                                  <th>行业</th>
                                  <th>注册资本</th>
                                  <th>成立日期</th>
                                </tr>
                              </thead>
                              <tbody></tbody>
                            </table>
                          </div>

                          <!-- 右边：缩小的环形图 -->
                          <div style="flex:1;min-width:220px;max-width:260px;">
                            <div id="chart-donut" class="chart" style="height:220px"></div>
                          </div>

                        </div>
                      </div>

                  <div class="card">
                    <div class="head">
                      <div class="title">交易明细表</div>
                      <div class="table-tabs" id="routineTabs">
                        <div class="table-tab active" data-view="flow">流水视图</div>
                        <div class="table-tab" data-view="counter">对手方视图</div>
                      </div>
                    </div>
                    <div class="content" style="overflow:auto;max-height:520px">
                      <table class="table" id="tblRoutineDetail">
                        <thead></thead>
                        <tbody></tbody>
                      </table>
                      <div id="pagination-routine" class="pagination"></div>
                    </div>
                  </div>
                </main>
              </div>
            </section>
          </div>
          <!-- ====== 你的“银行流水分析 · 完整版”内容结束 ====== -->
        </div>
      </div>
      <footer style="padding:6px 10px;background:#fff;border-top:1px solid #eaecef;font-size:12px"><P>KPMG Audit Compass V3.4.0(2025.2)</P></P>© 2025 毕马威科技服务(香港)有限公司 — 香港特别行政区有限责任公司，是与英国私营担保有限公司 — 毕马威国际有限公司相关联的独立成员所全球性组织中的成员。版权所有，不得转载。 毕马威的名称和标识均为毕马威全球性组织中的独立成员所经许可后使用的商标</P></footer>
    </section>
  </div>


  <!-- ====== 页面脚本：完整功能逻辑保持不变 ====== -->
  <script>
  /* =============== 工具 =============== */
  function ez(id,opt){const c=echarts.init(document.getElementById(id));c.setOption(opt);window.addEventListener('resize',()=>c.resize());return c;}
  function fmtWan(v){return (Math.round(v*10)/10).toLocaleString()}
  function randPick(arr){return arr[Math.floor(Math.random()*arr.length)]}

  /* =============== 造更真实的数据（本地随机） =============== */
  const companyPrefixes = ['上海','北京','深圳','杭州','广州','南京','成都','武汉','苏州','天津','重庆','合肥','西安'];
  const companyMains = ['恒信','弘业','中科','联创','佳成','宏泰','远景','蓝海','星宇','新锐','鼎盛','博纳','启航','微联','科迈','瑞博','瑞声','正泰','中智','普华','德勤','志成','航天','华科','长江','凌云'];
  const companySuffixes = ['科技有限公司','信息技术有限公司','实业有限公司','供应链管理有限公司','电子商务有限公司','商业管理有限公司','贸易有限公司','生物科技有限公司','智能科技有限公司','数据科技有限公司','医药有限公司','网络科技有限公司'];
  const funcs = ['总部','研发','销售','采购','生产','财务','人力','市场','客服','法务'];
  const banks = ['工行','建行','农行','中行','招行','交行','浦发','兴业','民生','中信'];
  const legals = ['张伟','王磊','李静','刘洋','陈杰','杨敏','赵强','黄芳','周颖','吴磊','郑凯','孙婷','朱敏','胡涛','郭强','何军','高磊','罗敏','梁杰','宋伟'];
  const rels = ['客户','供应商','员工','其他'];

  const N = 220; // 更多数据
  const companies = Array.from({length:N},(_,i)=>{
    const foundedDays = Math.floor(Math.random()*3650)+60; // 2个月~10年
    const employees = Math.floor(Math.random()*150);
    const inflow = +(Math.random()*1500+30).toFixed(1);   // 万
    const outflow= +(Math.random()*1300+20).toFixed(1);   // 万
    const txCnt  = Math.floor(Math.random()*120)+2;
    const total  = +(inflow+outflow).toFixed(1);
    const recognized = Math.random()>0.3;
    const date = new Date(Date.now()-foundedDays*86400000);
    const dstr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    const name = `${randPick(companyPrefixes)}${randPick(companyMains)}${randPick(companySuffixes)}`
    return {
      id:i+1,
      name,
      inflow, outflow, total, txCnt,
      rel: randPick(rels),
      bank: randPick(banks),
      recognized,
      foundedDays, foundedDate:dstr,
      capital: Math.floor(Math.random()*10000)+100, // 万
      legal: randPick(legals),
      status: Math.random()>0.08 ? '存续' : (Math.random()>0.5 ? '在业' : '注销'),
      lawsuits: Math.floor(Math.random()*8),
      dishonesty: Math.floor(Math.random()*4),
      employees,
      type: (Math.random()>0.72 ? (Math.random()>0.5?'个人':'个体工商户') : '公司'),

      // 新增字段
      blacklist: Math.random()>0.8 ? '是' : '否',
      ctype: ['客户','供应商','员工'][i%3],
      relation: ['母子公司','同股东','上下游'][i%3],
      sales: ['原料','成品','服务'][i%3],
      purchase: ['原料','成品','服务'][2-i%3],
      job: ['总经理','财务','员工'][i%3],
      note: '备注' + (i+1),
      startDate: '2019-01-01',
      endDate: '2029-12-31',
      term: '20年',
      industry: ['制造业','服务业','零售业'][i%3],
      scope: '主营业务范围描述',
      addr: '某市某区某路',
      contact: '010-88888888',
      directors: '张三/李四/王五'
    }
  });

    /* =============== 顶部筛选下拉：外置并填充选项 =============== */
    const auditedCompanies = [
      '被审计单位A集团有限公司','被审计单位B科技股份有限公司','被审计单位C实业发展有限公司','被审计单位D信息技术有限公司'
    ];
    function initFilters(){
      const fCompany=document.getElementById('fCompany');
      const fBank=document.getElementById('fBank');
      const fFunc=document.getElementById('fFunc');
      fCompany.innerHTML = ['<option value="all">全部</option>',...auditedCompanies.map(x=>`<option>${x}</option>`)].join('');
      const bankOpts = ['全部',...new Set(companies.map(x=>x.bank))];
      fBank.innerHTML = bankOpts.map(x=>`<option>${x}</option>`).join('');
      fFunc.innerHTML = ['全部',...funcs].map(x=>`<option>${x}</option>`).join('');
    }
    initFilters();

    // 顶部 tab 切换：只换 active，不改高度/白板
    document.querySelectorAll('#topTabs .tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('#topTabs .tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
  
        const key = tab.dataset.top; // 'biz' or 'routine'
        document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
        document.getElementById('pane-' + key).classList.add('active');
      });
    });


      
    /* =============== 经营实质：图表 =============== */
    const months = Array.from({length:17},(_,i)=> i<12?`2023-${String(i+1).padStart(2,'0')}`:`2024-${String(i-11).padStart(2,'0')}`);
    ez('chart-balance',{tooltip:{trigger:'axis'},xAxis:{type:'category',data:months},yAxis:{type:'value'},series:[{type:'line',smooth:true,areaStyle:{},data:months.map(()=>Math.round(Math.random()*120)+50)}]});
    ez('chart-io',{tooltip:{trigger:'axis'},legend:{data:['流入','流出']},xAxis:{type:'category',data:months},yAxis:{type:'value'},
      series:[{name:'流入',type:'bar',data:months.map(()=>Math.round(Math.random()*150)+40)},{name:'流出',type:'bar',data:months.map(()=>Math.round(Math.random()*130)+30)}]});
    ez('chart-compose',{tooltip:{trigger:'item'},series:[{type:'pie',radius:['42%','70%'],label:{formatter:'{b}\n{d}%'},data:[
      {name:'已识别',value:companies.filter(c=>c.recognized).length},
      {name:'未识别',value:companies.filter(c=>!c.recognized).length}
    ]}]});

    /* =============== 表格分页（10/页） =============== */
    let currentPageDeal=1,currentPageCorp=1,currentRoutinePage=1;
    const pageSize=10;
    let bizFilteredList = companies.slice(); // 经营实质区域当前筛选结果
    function paginate(arr,page){return arr.slice((page-1)*pageSize,page*pageSize);}
    function renderPagination(eleId,total,current,handler){
      const pages=Math.max(1,Math.ceil(total/pageSize));
      let html='';
      for(let i=1;i<=pages;i++){
        html+=`<button class="btn ${i===current?'btn-primary':''}" onclick="${handler}(${i})">${i}</button>`;
      }
      document.getElementById(eleId).innerHTML=html;
    }
    
  function toggleSb(li){
    li.classList.toggle('open');
    const submenu = li.querySelector('.sb-submenu');
    if (submenu) submenu.classList.toggle('show');
  }
      /* =============== 经营实质：两张表 =============== */
  function fillBizTables(list=bizFilteredList){
    const totalSum = list.reduce((s,x)=>s+x.total,0)||1;
    // 交易明细
    const dealPage=paginate(list,currentPageDeal);
    document.querySelector('#tblDeal tbody').innerHTML = dealPage.map(r=>`
      <tr>
        <td>${r.name}</td>
        <td>${r.ctype}</td><td>${r.relation}</td>
        <td>${r.blacklist}</td>
        <td style="color:#2563eb">${fmtWan(r.inflow)}</td>
        <td style="color:#ef4444">${fmtWan(r.outflow)}</td>
        <td><b>${fmtWan(r.total)}</b></td>
        <td>${(r.total/totalSum*100).toFixed(2)}%</td>
        <td>${r.txCnt}</td>
        <td>${r.sales}</td><td>${r.purchase}</td><td>${r.job}</td>
        <td>${r.note}</td>
        <td><button class="btn">查看详情</button></td>
      </tr>`).join('');
    renderPagination('pagination-deal',list.length,currentPageDeal,'gotoDeal');

    // 工商信息
    const corpPage=paginate(list,currentPageCorp);
    document.querySelector('#tblCorp tbody').innerHTML = corpPage.map(r=>`
      <tr>
        <td>${r.name}</td><td><b>${fmtWan(r.total)}</b></td>
        <td>${r.foundedDate}</td><td>${r.startDate}</td><td>${r.endDate}</td>
        <td>${r.term}</td><td>${r.status}</td><td>${r.capital}</td>
        <td>${r.industry}</td><td>${r.scope}</td><td>${r.addr}</td>
        <td>${r.contact}</td><td>${r.directors}</td>
      </tr>`).join('');
    renderPagination('pagination-corp',list.length,currentPageCorp,'gotoCorp');
  }
  function gotoDeal(p){currentPageDeal=p;fillBizTables()}
  function gotoCorp(p){currentPageCorp=p;fillBizTables()}
  fillBizTables();

    /* 表格顶部 Tab 切换 */
    document.getElementById('listTabs').addEventListener('click',e=>{
      const tab=e.target.closest('.table-tab'); if(!tab) return;
      [...e.currentTarget.children].forEach(x=>x.classList.remove('active')); tab.classList.add('active');
      const showDeal = tab.dataset.view==='deal';
      document.getElementById('tbl-deal-wrap').classList.toggle('hide',!showDeal);
      document.getElementById('tbl-corp-wrap').classList.toggle('hide',showDeal);
    });

    /* =============== 经营实质：筛选（演示逻辑） =============== */
    document.getElementById('btnQueryBiz').onclick=()=>{
      const typeSel=document.getElementById('fType').value;
      const bankSel=document.getElementById('fBank').value;
      // 这里 fCompany、fFunc 仅作为 UI 展示，如有真实映射可在此扩展
      let filtered = companies.slice();
      if(typeSel!=='all') filtered = filtered.filter(x=>x.rel===typeSel);
      if(bankSel!=='全部') filtered = filtered.filter(x=>x.bank===bankSel);
      bizFilteredList = filtered;
      currentPageDeal=1; currentPageCorp=1;
      fillBizTables(filtered);
    };
    document.getElementById('btnResetBiz').onclick=()=>{
      document.getElementById('fCompany').selectedIndex=0;
      document.getElementById('fBank').selectedIndex=0;
      document.getElementById('fFunc').selectedIndex=0;
      document.getElementById('fPeriod').selectedIndex=0;
      document.getElementById('fType').selectedIndex=0;
      bizFilteredList = companies.slice();
      currentPageDeal=1; currentPageCorp=1;
      fillBizTables();
    };

    /* =============== Routine 区域 =============== */
    const routineMenu=document.getElementById('routineMenu');
    routineMenu.addEventListener('click',e=>{
      const it=e.target.closest('.item'); if(!it) return;
      [...routineMenu.children].forEach(m=>m.classList.remove('active')); it.classList.add('active');
      renderRoutine(it.dataset.code);
    });

    /* 指标条 */
    function makeStrip(list){
      const inSum  = list.reduce((s,x)=>s+x.inflow,0);
      const outSum = list.reduce((s,x)=>s+x.outflow,0);
      const set = new Set(list.map(x=>x.name));
      const inflowCompany = new Set(list.filter(x=>x.inflow>0).map(x=>x.name)).size;
      const outflowCompany= new Set(list.filter(x=>x.outflow>0).map(x=>x.name)).size;
      const html = `
        <div class="top-item"><div class="lbl">识别对手方数</div><div class="num">${set.size}</div></div>
        <div class="top-item"><div class="lbl">流入客户数</div><div class="num">${inflowCompany}</div></div>
        <div class="top-item"><div class="lbl">流出客户数</div><div class="num">${outflowCompany}</div></div>
        <div class="top-item"><div class="lbl">交易额合计(万)</div><div class="num">${fmtWan(inSum+outSum)}</div></div>
        <div class="top-item"><div class="lbl">流入金额(万)</div><div class="num">${fmtWan(inSum)}</div></div>
        <div class="top-item"><div class="lbl">流出金额(万)</div><div class="num">${fmtWan(outSum)}</div></div>`;
      document.getElementById('topStrip').innerHTML = html;
    }

    /* Top20 列表 + 环形图 */
    function renderTop20(list){
      const top20 = list.slice().sort((a,b)=>b.total-a.total).slice(0,20);
      const totalTop = top20.reduce((s,x)=>s+x.total,0);
      document.getElementById('rankTotal').innerText = fmtWan(totalTop)+' 万';

      const tbody = document.querySelector('#tblTop20 tbody');
      tbody.innerHTML = '';
      const colors=['#f59e0b','#f97316','#ef4444','#22c55e','#3b82f6',
                    '#8b5cf6','#06b6d4','#14b8a6','#eab308','#a855f7'];

      top20.forEach((r,i)=>{
        const color = colors[i%colors.length];
        tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td><span class="color-dot" style="background:${color}"></span>${i+1}</td>
        <td>${r.name}</td>
        <td><b>${fmtWan(r.total)}</b></td>
        <td style="color:#2563eb">${fmtWan(r.inflow)}</td>
        <td style="color:#ef4444">${fmtWan(r.outflow)}</td>
        <td>${r.txCnt||'-'}</td>
        <td>${r.ctype||'-'}</td>
        <td>${r.relation||'-'}</td>
        <td>${r.industry||'-'}</td>
        <td>${r.capital||'-'}</td>
        <td>${r.foundedDate||'-'}</td>
    </tr>
    `);
      });

      // 环形图
      ez('chart-donut',{
        tooltip:{trigger:'item'},
        series:[{
          type:'pie',
          radius:['55%','75%'],
          label:{show:true,formatter:'{d}%'},
          data:top20.map((r,i)=>({
            name:r.name,
            value:r.total,
            itemStyle:{color:colors[i%colors.length]}
          }))
        }]
      });
    }

    /* 正态拟合线（按Y=交易额） */
    function gaussianLine(values){
      const n=values.length||1;
      const mean = values.reduce((s,x)=>s+x,0)/n;
      const sd = Math.sqrt(values.reduce((s,x)=>s+(x-mean)*(x-mean),0)/n) || 1;
      const min = Math.max(0, Math.min(...values));
      const max = Math.max(...values);
      const xs = Array.from({length:60},(_,i)=>min+(max-min)*i/59);
      const ys = xs.map(x=> 1/(sd*Math.sqrt(2*Math.PI)) * Math.exp(-0.5*((x-mean)/sd)**2));
      const maxY = Math.max(...ys)||1;
      return {xs, ys: ys.map(y=> y/maxY * (Math.max(...values)*0.6))}; // 缩放
    }
    
    
    /* Routine 渲染（含分页） */
    let routineFiltered = companies.slice();
    function renderRoutine(code='2.1'){
      const rf=document.getElementById('routineFilters');
      let xName='经营天数', filterFn=(x)=>true;

      if(code==='2.1'){
        document.getElementById('rTitle').innerText='1. 经营时间较短 · 结果';
        document.getElementById('scatterTitle').innerText='经营天数 vs 交易金额（散点+正态拟合）';
        rf.innerHTML = `
      <label>经营时间：</label>
      <select class="select" id="rLayer">
        <option value="all">全部</option>
        <option value="lt1"><1年</option>
        <option value="1-2">1-2年</option>
        <option value="ge3">≥3年</option>
    </select>
      <label>交易年度：</label>
      <select class="select" id="rYear">
        <option value="all">全部</option>
        <option>2022</option>
        <option>2023</option>
        <option>2024</option>
    </select>
      <label>客户标签：</label>
      <select class="select" id="rCtype">
        <option value="all">全部</option>
        <option>客户</option>
        <option>供应商</option>
        <option>员工</option>
    </select>
      <label>金额范围：</label>
      <select class="select" id="rAmt">
        <option value="all">全部</option>
        <option value="le100">≤100万</option>
        <option value="100-500">100-500万</option>
        <option value="gt500">≥500万</option>
    </select>
      <button class="btn" id="btnApplyRoutine">应用筛选</button>
    `;
        filterFn = (r) => {
          const layer = document.getElementById('rLayer')?.value || 'all';
          const year = document.getElementById('rYear')?.value || 'all';
          const ctype = document.getElementById('rCtype')?.value || 'all';
          const amt = document.getElementById('rAmt')?.value || 'all';

          if (layer === 'lt1' && r.foundedDays >= 365) return false;
          if (layer === '1-2' && !(r.foundedDays >= 365 && r.foundedDays < 730)) return false;
          if (layer === 'ge3' && r.foundedDays < 1095) return false;
          if (year !== 'all' && !r.foundedDate.startsWith(year)) return false;
          if (ctype !== 'all' && r.ctype !== ctype) return false;
          if (amt === 'le100' && r.total > 100) return false;
          if (amt === '100-500' && !(r.total >= 100 && r.total <= 500)) return false;
          if (amt === 'gt500' && r.total <= 500) return false;

          return true;
        };
        xName = '经营天数';
      }else if(code==='2.2'){
        document.getElementById('rTitle').innerText='2. 社保缴纳人数较少 · 结果';
        document.getElementById('scatterTitle').innerText='缴纳人数 vs 交易金额（散点+正态拟合）';
        rf.innerHTML = `
      <label>社保人数：</label>
      <select class="select" id="rSocial">
        <option value="all">全部</option>
        <option value="lt50"><50</option>
        <option value="50-99">50-99</option>
        <option value="ge100">≥100</option>
      </select>
      <label>交易年度：</label>
      <select class="select" id="rYear">
        <option value="all">全部</option>
        <option>2022</option>
        <option>2023</option>
        <option>2024</option>
      </select>
      <label>客户标签：</label>
      <select class="select" id="rCtype">
        <option value="all">全部</option>
        <option>客户</option>
        <option>供应商</option>
        <option>员工</option>
      </select>
      <label>金额范围：</label>
      <select class="select" id="rAmt">
        <option value="all">全部</option>
        <option value="le100">≤100万</option>
        <option value="100-500">100-500万</option>
        <option value="gt500">≥500万</option>
      </select>
      <button class="btn" id="btnApplyRoutine">应用筛选</button>
    `;
    filterFn = (r) => {
      const social = document.getElementById('rSocial')?.value || 'all';
      const year = document.getElementById('rYear')?.value || 'all';
      const ctype = document.getElementById('rCtype')?.value || 'all';
      const amt = document.getElementById('rAmt')?.value || 'all';

      if (social === 'lt50' && r.employees >= 50) return false;
      if (social === '50-99' && !(r.employees >= 50 && r.employees <= 99)) return false;
      if (social === 'ge100' && r.employees < 100) return false;
      if (year !== 'all' && !r.foundedDate.startsWith(year)) return false;
      if (ctype !== 'all' && r.ctype !== ctype) return false;
      if (amt === 'le100' && r.total > 100) return false;
      if (amt === '100-500' && !(r.total >= 100 && r.total <= 500)) return false;
      if (amt === 'gt500' && r.total <= 500) return false;

      return true;
    };
    xName = '缴纳人数';
      }else{
        document.getElementById('rTitle').innerText='3. 为个人或个体工商户 · 结果';
        document.getElementById('scatterTitle').innerText='主体编号 vs 交易金额（散点+正态拟合）';
        rf.innerHTML=`
        <label>主体：</label>
      <select class="select" id="pType">
        <option value="all">全部</option>
        <option>个人</option>
        <option>个体工商户</option>
      </select>
      <label>交易年度：</label>
      <select class="select" id="rYear">
        <option value="all">全部</option>
        <option>2022</option>
        <option>2023</option>
        <option>2024</option>
      </select>
      <label>客户标签：</label>
      <select class="select" id="rCtype">
        <option value="all">全部</option>
        <option>客户</option>
        <option>供应商</option>
        <option>员工</option>
      </select>
      <label>金额范围：</label>
      <select class="select" id="rAmt">
        <option value="all">全部</option>
        <option value="le100">≤100万</option>
        <option value="100-500">100-500万</option>
        <option value="gt500">≥500万</option>
      </select>
      <button class="btn" id="btnApplyRoutine">应用筛选</button>
    `;
    filterFn = (r) => {
      const pType = document.getElementById('pType')?.value || 'all';
      const year = document.getElementById('rYear')?.value || 'all';
      const ctype = document.getElementById('rCtype')?.value || 'all';
      const amt = document.getElementById('rAmt')?.value || 'all';

      if (pType !== 'all' && r.type !== pType) return false;
      if (year !== 'all' && !r.foundedDate.startsWith(year)) return false;
      if (ctype !== 'all' && r.ctype !== ctype) return false;
      if (amt === 'le100' && r.total > 100) return false;
      if (amt === '100-500' && !(r.total >= 100 && r.total <= 500)) return false;
      if (amt === 'gt500' && r.total <= 500) return false;

      return true;
    };
    xName = '主体编号';
  
      }

      function apply(){
        let list = companies.slice();
        if(code==='2.3'){ list = list.filter(r=>r.type!=='公司'); }
        list = list.filter(filterFn);

        routineFiltered = list;
        currentRoutinePage = 1;

        // 指标条
        makeStrip(list);

        // 散点 + 拟合
        const points = list.map((r,idx)=>{
          const x = (code==='2.1') ? r.foundedDays : (code==='2.2'? r.employees : idx+1);
          const y = r.total;
          const size = Math.max(6, Math.sqrt(y)); // 交易额大的点更大
          return {name:r.name, value:[x,y], symbolSize:size, extra:r};
        });
        const fit = gaussianLine(list.map(r=>r.total));
        ez('chart-scatter',{
          tooltip:{formatter:(p)=>{
            const d=p.data.extra;
            const xVal = (code==='2.1')? `${d.foundedDays} 天` : (code==='2.2'? `${d.employees} 人` : `#${p.dataIndex+1}`);
            return `${d.name}<br/>X：${xVal}<br/>流入：${fmtWan(d.inflow)} 万<br/>流出：${fmtWan(d.outflow)} 万<br/>交易额：<b>${fmtWan(d.total)} 万</b><br/>交易笔数：${d.txCnt}`;
          }},
          xAxis:{name:xName,type:'value',axisLine:{onZero:false}},
          yAxis:{name:'交易金额(万)',type:'value'},
          series:[
            {type:'scatter',data:points,emphasis:{scale:1.15}},
            {type:'line',name:'正态拟合',data:fit.xs.map((x,i)=>[x,fit.ys[i]]),smooth:true,showSymbol:false,areaStyle:{opacity:.08}}
          ]
        });

        // Top20
        renderTop20(list);

        // 明细表 + 分页
        renderRoutineTable();
      }

      document.getElementById('routineFilters').onclick=(e)=>{ if(e.target.id==='btnApplyRoutine') apply(); };
      apply();
    }
let routineView = 'flow'; // 默认流水视图

document.getElementById('routineTabs').addEventListener('click', e=>{
  const tab = e.target.closest('.table-tab');
  if(!tab) return;
  [...routineTabs.children].forEach(x=>x.classList.remove('active'));
  tab.classList.add('active');
  routineView = tab.dataset.view;
  renderRoutineTable(); // 切换后重绘表格
});

function renderRoutineTable(){
  const list = routineFiltered.slice();
  const pageItems = paginate(list,currentRoutinePage);
  const thead = document.querySelector('#tblRoutineDetail thead');
  const tbody = document.querySelector('#tblRoutineDetail tbody');

  if(routineView==='flow'){ // 流水视图
    thead.innerHTML = `
      <tr>
        <th>本方名称</th><th>本方账号</th><th>对方名称</th><th>交易日期</th>
        <th>交易时间</th><th>币种</th><th>流入金额</th><th>流出金额</th>
        <th>交易后余额</th><th>等值人民币余额</th><th>交易类型</th>
        <th>流水识别号</th><th>摘要</th><th>流水明细尽调备注</th>
        <th>关联关系</th><th>所属集团</th><th>对手方类型</th><th>销售类别</th>
      </tr>`;
    tbody.innerHTML = pageItems.map(d=>`
      <tr>
        <td>${d.name}</td><td>6222****${d.id}</td><td>对方${d.id}</td>
        <td>2024-0${(d.id%9)+1}-15</td><td>${String(8+d.id%10)}:${String(d.id%60).padStart(2,'0')}</td>
        <td>CNY</td>
        <td style="color:#2563eb">${fmtWan(d.inflow)}</td>
        <td style="color:#ef4444">${fmtWan(d.outflow)}</td>
        <td>${fmtWan(d.total-d.outflow)}</td><td>${fmtWan(d.total)}</td>
        <td>转账</td><td>TX${10000+d.id}</td>
        <td>摘要${d.id}</td><td>备注${d.id}</td><td>${d.relation}</td>
        <td>集团${d.id%5+1}</td><td>${d.ctype}</td><td>${d.sales}</td>
      </tr>`).join('');
  } else { // 对手方视图
    thead.innerHTML = `
      <tr>
        <th>对手方名称</th><th>流入总额</th><th>流出总额</th><th>交易总额</th>
        <th>异常交易总额</th><th>占比1</th><th>占比2</th>
        <th>异常交易笔数</th><th>交易次数</th><th>对手方类型</th>
        <th>关联关系</th><th>销售类别</th><th>采购类别</th>
        <th>职位</th><th>所属集团</th>
      </tr>`;
    tbody.innerHTML = pageItems.map(d=>`
      <tr>
        <td>${d.name}</td>
        <td style="color:#2563eb">${fmtWan(d.inflow)}</td>
        <td style="color:#ef4444">${fmtWan(d.outflow)}</td>
        <td><b>${fmtWan(d.total)}</b></td>
        <td>${fmtWan(d.outflow*0.15)}</td>
        <td>${(Math.random()*10).toFixed(2)}%</td>
        <td>${(Math.random()*5).toFixed(2)}%</td>
        <td>${Math.floor(d.txCnt*0.1)}</td>
        <td>${d.txCnt}</td><td>${d.ctype}</td><td>${d.relation}</td>
        <td>${d.sales}</td><td>${d.purchase}</td><td>${d.job}</td>
        <td>集团${d.id%5+1}</td>
      </tr>`).join('');
  }

  renderPagination('pagination-routine', list.length, currentRoutinePage, 'gotoRoutine');
}

function gotoRoutine(p){
  currentRoutinePage=p;
  renderRoutineTable();
}

// 初始化
renderRoutine('2.1');

    /* =============== 顶部页面切换 =============== */
    document.getElementById('topTabs').addEventListener('click',e=>{
      const t=e.target.closest('.tab'); if(!t) return;
      [...e.currentTarget.children].forEach(x=>x.classList.remove('active')); t.classList.add('active');
      document.getElementById('page-biz').classList.toggle('hide',t.dataset.top!=='biz');
      document.getElementById('page-routine').classList.toggle('hide',t.dataset.top!=='routine');
      setTimeout(()=>window.dispatchEvent(new Event('resize')),50);
    });
  </script>
</body>
</html>
